<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aethel Locker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ace.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    animation: { 'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1)', 'fade-in': 'fadeIn 0.3s ease-out' },
                    keyframes: { slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }, fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } } }
                }
            }
        }
    </script>

    <style>
        body { 
            background-color: #ffffff; 
            color: #1f2937;
            background-image: linear-gradient(rgba(59, 130, 246, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(147, 51, 234, 0.05) 1px, transparent 1px); 
            background-size: 40px 40px; 
            animation: moveGrid 60s linear infinite; 
            min-height: 100vh; margin: 0; font-family: 'Inter', sans-serif; overflow: hidden; 
        }
        
        @keyframes moveGrid { 0% { background-position: 0 0; } 100% { background-position: 40px 40px; } }
        
        .glass-panel { 
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.6); 
            box-shadow: 0 8px 32px -4px rgba(31, 38, 135, 0.1); 
        }

        .text-gradient { background: linear-gradient(to right, #2563eb, #9333ea); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        button, input, div { transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1); }
        #editor-container, #readonly-editor { font-family: 'JetBrains Mono', monospace; border-radius: 0.5rem; }
        
        /* Modern Checkbox Toggle */
        .toggle-checkbox { appearance: none; width: 3rem; height: 1.5rem; background: #e5e7eb; border-radius: 9999px; position: relative; cursor: pointer; transition: background 0.3s; }
        .toggle-checkbox::after { content: ''; position: absolute; top: 0.15rem; left: 0.15rem; width: 1.2rem; height: 1.2rem; background: white; border-radius: 50%; transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .toggle-checkbox:checked { background: #2563eb; }
        .toggle-checkbox:checked::after { transform: translateX(1.5rem); }

        /* GitHub Style Markdown */
        .markdown-body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans",Helvetica,Arial,sans-serif; font-size: 16px; line-height: 1.5; color: #24292f; background-color: #ffffff; padding: 2rem; border-radius: 0 0 6px 6px; }
        .markdown-body h1, .markdown-body h2 { border-bottom: 1px solid #d0d7de; padding-bottom: .3em; margin-top: 24px; margin-bottom: 16px; font-weight: 600; line-height: 1.25; }
        .markdown-body h1 { font-size: 2em; } 
        .markdown-body pre { background-color: #f6f8fa; border-radius: 6px; font-size: 85%; line-height: 1.45; overflow: auto; padding: 16px; margin-top: 16px; margin-bottom: 16px; position: relative; }
        .markdown-body code { background-color: rgba(175,184,193,0.2); border-radius: 6px; font-family: ui-monospace,SFMono-Regular,SF Mono,Menlo,Consolas,Liberation Mono,monospace; font-size: 85%; margin: 0; padding: .2em .4em; }
        .markdown-body pre code { background-color: transparent; padding: 0; }
        .copy-btn { position: absolute; top: 8px; right: 8px; background: #ffffff; color: #24292f; border: 1px solid #d0d7de; padding: 3px 8px; border-radius: 6px; font-size: 12px; cursor: pointer; opacity: 0; transition: opacity 0.2s; }
        .markdown-body pre:hover .copy-btn { opacity: 1; } .copy-btn:hover { background: #f3f4f6; }
    </style>
</head>
<body class="flex items-center justify-center p-4 h-screen w-screen relative">

    <div id="auth-wrapper" class="w-full max-w-md animate-slide-up z-50">
        <div id="login-container" class="glass-panel p-8 rounded-2xl shadow-2xl relative bg-white/80">
            <div class="mb-6 flex justify-center"><div class="bg-gradient-to-r from-blue-600 to-purple-600 p-4 rounded-2xl shadow-lg"><i data-lucide="lock" class="w-8 h-8 text-white"></i></div></div>
            <h1 class="text-3xl font-bold mb-2 text-gradient tracking-tight">Aethel Locker</h1>
            <p class="text-gray-500 mb-6 text-sm">Please verify your identity.</p>
            <form id="email-form" class="space-y-4" onsubmit="handleEmailSubmit(event)">
                <div class="text-left"><label class="block text-xs font-semibold uppercase text-gray-500 mb-1 ml-1">Email</label><input type="email" id="email" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-4 focus:ring-blue-500/10 outline-none" placeholder="name@example.com"></div>
                <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold py-3 rounded-xl hover:shadow-lg transform transition active:scale-95">Check Access</button>
            </form>
        </div>
        <div id="apikey-container" class="glass-panel p-8 rounded-2xl shadow-2xl bg-white/80 hidden relative">
            <button onclick="backToEmail()" class="absolute top-4 left-4 p-2 rounded-full hover:bg-gray-100 text-gray-400"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
            <div class="mb-6 flex justify-center"><div class="bg-gray-100 p-4 rounded-2xl"><i data-lucide="key" class="w-8 h-8 text-gray-600"></i></div></div>
            <h1 class="text-2xl font-bold mb-2 text-gray-800">API Gateway</h1>
            <p class="text-gray-500 mb-6 text-sm">Enter your secure API key.</p>
            <form id="apikey-form" class="space-y-4" onsubmit="handleApiKeySubmit(event)">
                <div class="text-left"><label class="block text-xs font-semibold uppercase text-gray-500 mb-1 ml-1">API Key</label><input type="password" id="apikey" required class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none" placeholder="sk_live_..."></div>
                <button type="submit" class="w-full bg-gray-900 text-white font-semibold py-3 rounded-xl hover:bg-black transform transition active:scale-95">Authenticate</button>
            </form>
            <p id="api-error" class="text-red-500 text-sm mt-4 hidden text-center bg-red-50 py-2 rounded-lg"></p>
        </div>
        <div id="2fa-email-modal" class="glass-panel p-8 rounded-2xl shadow-2xl bg-white/80 hidden relative text-center">
            <div class="mb-6 flex justify-center"><div class="bg-blue-100 p-4 rounded-full animate-pulse"><i data-lucide="shield" class="w-8 h-8 text-blue-600"></i></div></div>
            <h2 class="text-xl font-bold text-gray-800">Verification Required</h2>
            <p class="text-gray-500 mt-2 text-sm mb-6">Additional security check required.</p>
            <button onclick="openPinEntry()" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-xl hover:bg-blue-700 transition">Continue</button>
        </div>
        <div id="2fa-pin-modal" class="glass-panel p-8 rounded-2xl shadow-2xl bg-white/80 hidden relative text-center">
            <div class="mb-4"><i data-lucide="shield-check" class="w-8 h-8 text-green-600 mx-auto"></i></div>
            <h2 class="text-lg font-bold text-gray-800 mb-4">Enter PIN Code</h2>
            <div class="flex justify-center gap-2 mb-6"><input type="password" id="pin-input" maxlength="6" class="text-center text-2xl font-mono tracking-widest w-40 px-2 py-2 border-b-2 border-gray-300 focus:border-blue-500 outline-none bg-transparent" placeholder="••••"></div>
            <button onclick="verifyPinAndLogin()" class="w-full bg-green-600 text-white font-semibold py-2 rounded-lg hover:bg-green-700 transition">Confirm</button>
            <p id="pin-error" class="text-red-500 text-xs mt-3 hidden">Incorrect PIN</p>
        </div>
    </div>

    <div id="dashboard-container" class="hidden w-full h-[95vh] max-w-[1400px] glass-panel rounded-3xl overflow-hidden flex shadow-2xl animate-slide-up z-40">
        <div class="w-72 bg-white/60 border-r border-gray-100 flex flex-col backdrop-blur-xl">
            <div class="p-8 border-b border-gray-100/50 flex items-center gap-3"><div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-500 rounded-xl flex items-center justify-center text-white font-bold text-lg">A</div><span class="font-bold text-xl tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-gray-900 to-gray-600">Aethel Locker</span></div>
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <button onclick="switchTab('projects')" id="tab-btn-projects" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-2xl text-left bg-blue-50/50 text-blue-700 font-medium border border-blue-100"><i data-lucide="layout-grid" class="w-5 h-5"></i> Projects</button>
                <div id="admin-tabs" class="hidden space-y-2">
                    <button onclick="switchTab('api')" id="tab-btn-api" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-2xl text-left text-gray-500 hover:bg-white/50 border border-transparent"><i data-lucide="key" class="w-5 h-5"></i> Admin API</button>
                    <button onclick="switchTab('registration')" id="tab-btn-registration" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-2xl text-left text-gray-500 hover:bg-white/50 border border-transparent"><i data-lucide="users" class="w-5 h-5"></i> Registration</button>
                </div>
                <button onclick="switchTab('global-settings')" id="tab-btn-settings" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-2xl text-left text-gray-500 hover:bg-white/50 border border-transparent"><i data-lucide="settings-2" class="w-5 h-5"></i> Settings</button>
            </nav>
            <div class="p-4 border-t border-gray-100"><div class="flex items-center gap-3 px-3 py-3 bg-white/50 rounded-2xl border border-gray-100 shadow-sm"><div class="w-9 h-9 rounded-full bg-gradient-to-tr from-purple-100 to-blue-100 flex items-center justify-center text-purple-600 font-bold text-sm border border-white shadow-sm" id="user-avatar"></div><div class="flex-1 overflow-hidden"><p class="text-xs font-bold text-gray-800 truncate" id="display-name"></p><p class="text-[10px] text-emerald-600 font-bold uppercase tracking-wider" id="access-level"></p></div></div></div>
        </div>

        <main class="flex-1 bg-white/40 overflow-hidden relative flex flex-col">
            <div id="view-projects" class="flex-1 overflow-y-auto p-10 animate-fade-in">
                <header class="flex justify-between items-end mb-10"><div><h2 class="text-3xl font-bold text-gray-800">Projects</h2></div><button onclick="openCreateModal()" class="bg-gray-900 text-white px-5 py-2.5 rounded-xl text-sm font-semibold hover:bg-gray-800 flex items-center gap-2"><i data-lucide="plus-circle" class="w-4 h-4"></i> New Project</button></header>
                <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
                <div id="empty-state" class="hidden flex-col items-center justify-center text-center p-20 border-2 border-dashed border-gray-200 rounded-3xl"><i data-lucide="folder-plus" class="w-10 h-10 text-gray-300 mb-4"></i><h3 class="text-xl font-bold text-gray-900">No projects yet</h3><button onclick="openCreateModal()" class="text-blue-600 font-bold mt-2 hover:underline">Create Project</button></div>
            </div>

            <div id="view-admin-api" class="hidden flex-1 overflow-y-auto p-10 animate-fade-in"><header class="mb-10"><h2 class="text-3xl font-bold text-gray-800">API Management</h2></header><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="bg-white p-6 rounded-2xl shadow-sm border h-fit"><h3 class="font-bold mb-4 text-gray-800">Generate Key</h3><div class="space-y-4"><div><label class="block text-sm font-semibold mb-1 text-gray-500">Duration (Days)</label><input type="number" id="api-duration" value="30" class="w-full px-4 py-2 border rounded-xl"></div><button onclick="generateApiKey()" class="w-full bg-blue-600 text-white font-bold py-2.5 rounded-xl hover:bg-blue-700">Generate</button></div><div id="generated-key-display" class="hidden mt-6 p-4 bg-gray-50 rounded-xl break-all"><p class="text-xs font-bold uppercase text-gray-500">New Key</p><p id="new-key-text" class="font-mono text-blue-600 font-bold"></p></div></div><div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border overflow-hidden"><div class="p-6 border-b"><h3 class="font-bold text-gray-800">Keys Monitor</h3></div><table class="w-full text-left text-sm"><thead class="bg-gray-50 text-gray-500 font-semibold border-b"><tr><th class="px-6 py-4">Key</th><th class="px-6 py-4">User</th><th class="px-6 py-4">Expires</th><th class="px-6 py-4">Actions</th></tr></thead><tbody id="api-keys-list" class="divide-y divide-gray-100"></tbody></table></div></div></div>
            <div id="view-admin-registration" class="hidden flex-1 overflow-y-auto p-10 animate-fade-in"><header class="mb-10"><h2 class="text-3xl font-bold text-gray-800">Registration</h2></header><div class="bg-white rounded-2xl shadow-sm border overflow-hidden"><table class="w-full text-left text-sm"><thead class="bg-gray-50 text-gray-500 font-semibold border-b"><tr><th class="px-6 py-4">Email</th><th class="px-6 py-4">Key Used</th><th class="px-6 py-4">Date</th></tr></thead><tbody id="registration-list" class="divide-y divide-gray-100"></tbody></table></div></div>

            <div id="view-settings" class="hidden p-10 animate-fade-in">
                <header class="mb-8"><h2 class="text-3xl font-bold text-gray-800">Settings</h2></header>
                <div class="space-y-6 max-w-2xl">
                    <div class="bg-white rounded-2xl border p-6"><h3 class="font-bold text-gray-800 mb-4">Profile</h3><div class="space-y-4"><div><label class="block text-sm font-medium mb-1 text-gray-500">Username</label><div class="flex gap-2"><input type="text" id="setting-username" class="px-4 py-2 border rounded-lg w-full"><button onclick="saveProfile()" class="bg-gray-900 text-white px-4 py-2 rounded-lg text-sm">Update</button></div></div><div class="flex justify-between items-center"><span class="text-gray-800">Anonymous Mode</span><input type="checkbox" id="setting-anon-toggle" class="toggle-checkbox" onchange="toggleAnonymous()"></div></div></div>
                    <div class="bg-white rounded-2xl border p-6"><h3 class="font-bold text-gray-800 mb-4">Security</h3><div class="space-y-4"><div><label class="block text-sm font-medium mb-1 text-gray-500">PIN Code</label><div class="flex gap-2"><input type="password" id="setting-pin" maxlength="6" class="px-4 py-2 border rounded-lg w-48"><button onclick="savePin()" class="bg-gray-800 text-white px-4 py-2 rounded-lg text-sm">Save</button></div></div><div class="flex justify-between items-center"><span class="text-gray-800">2FA Enabled</span><input type="checkbox" id="setting-2fa-toggle" class="toggle-checkbox" onchange="toggle2FA()"></div></div></div>
                    <div class="bg-white rounded-2xl border p-6 bg-red-50/50"><button onclick="logout()" class="text-red-600 font-bold flex items-center gap-2"><i data-lucide="log-out" class="w-4 h-4"></i> Sign Out</button></div>
                </div>
            </div>

            <div id="view-project-detail" class="hidden h-full flex flex-col animate-fade-in bg-white/30">
                <div class="bg-white/80 backdrop-blur-md border-b px-8 py-4 flex justify-between items-center"><div class="flex items-center gap-4"><button onclick="closeProjectView()"><i data-lucide="arrow-left" class="w-4 h-4"></i></button><h1 id="detail-project-name" class="text-xl font-bold text-gray-800"></h1></div><span id="detail-owner-tag" class="text-xs text-gray-500 font-mono"></span></div>
                <div class="bg-white/50 border-b px-8 flex gap-8"><button onclick="switchProjectTab('code')" id="ptab-code" class="py-4 text-sm font-semibold border-b-2 border-orange-500 text-gray-800">Code</button><button onclick="switchProjectTab('settings')" id="ptab-settings" class="py-4 text-sm font-medium border-b-2 border-transparent text-gray-500">Settings</button></div>
                
                <div id="project-code-panel" class="flex-1 p-8 overflow-y-auto">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-6">
                        <div class="bg-gray-50/80 px-4 py-3 flex justify-between items-center border-b border-gray-200">
                            <span class="font-bold text-gray-700 text-sm">Files</span>
                            <div class="flex gap-2">
                                <button onclick="openUploadModal()" class="text-xs bg-white border border-gray-300 px-3 py-1.5 rounded-lg font-medium hover:bg-gray-50 transition text-gray-700">Upload</button>
                                <button onclick="openAddFileView()" class="text-xs bg-green-600 text-white px-3 py-1.5 rounded-lg font-bold hover:bg-green-700 transition">Add File</button>
                            </div>
                        </div>
                        <div id="file-list-container" class="divide-y divide-gray-100"></div>
                    </div>

                    <div id="readme-section" class="border border-[#d0d7de] rounded-lg overflow-hidden bg-white hidden">
                        <div class="px-4 py-2 bg-[#f6f8fa] border-b border-[#d0d7de] flex items-center gap-2">
                            <i data-lucide="book-open" class="w-4 h-4 text-[#57606a]"></i>
                            <span class="text-sm font-bold text-[#24292f]">README</span>
                        </div>
                        <div id="readme-content" class="markdown-body"></div>
                    </div>
                </div>

                <div id="project-settings-panel" class="hidden flex-1 p-8 overflow-y-auto">
                    <div class="max-w-2xl mx-auto space-y-6">
                        <div class="bg-white rounded-xl border p-6"><h3 class="font-bold mb-4 text-gray-800">Rename</h3><div class="flex gap-2"><input id="setting-project-name" class="border px-4 py-2 rounded-lg flex-1"><button onclick="saveProjectName()" class="bg-gray-900 text-white px-4 py-2 rounded-lg">Save</button></div></div>
                        <div class="bg-white rounded-xl border p-6">
                            <h3 class="font-bold mb-4 flex items-center gap-2 text-gray-800"><i data-lucide="users" class="w-4 h-4 text-blue-500"></i> Collaboration</h3>
                            <div class="flex gap-2 mb-4 relative"><input id="collab-search" placeholder="Search user..." class="border px-4 py-2 rounded-lg flex-1"><button onclick="searchUsers()" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Search</button><div id="search-results" class="absolute top-12 left-0 w-full bg-white border rounded-xl shadow-xl z-50 hidden p-2"></div></div>
                            <div id="collab-list" class="space-y-2"></div>
                        </div>
                        <button onclick="deleteProject()" class="mt-4 bg-red-100 text-red-600 px-4 py-2 rounded-lg w-full">Delete Project</button>
                    </div>
                </div>
            </div>

            <div id="view-editor" class="hidden h-full flex flex-col animate-fade-in bg-white/50"><div class="px-8 py-4 border-b bg-white/80 flex justify-between"><button onclick="cancelEdit()"><i data-lucide="x" class="w-5 h-5"></i></button><div class="flex gap-2 bg-gray-100 rounded-lg px-3 py-1"><input id="editor-filename" class="bg-transparent outline-none"></div><button onclick="commitFile()" class="bg-green-600 text-white px-6 py-2 rounded-lg">Commit</button></div><div class="flex-1 p-4 relative bg-[#282c34]"><div id="editor-container" class="w-full h-full"></div></div></div>
            <div id="view-file-display" class="hidden h-full flex flex-col animate-fade-in bg-gray-50"><div class="bg-white border-b px-6 py-4 flex justify-between items-center"><div class="flex gap-3"><h2 id="display-filename" class="font-bold text-gray-800"></h2></div><div class="flex gap-2"><div id="md-toggle-container" class="hidden bg-gray-100 rounded p-1 flex gap-1"><button onclick="toggleMdView('preview')" id="btn-md-preview" class="px-2 text-xs rounded bg-white">Preview</button><button onclick="toggleMdView('code')" id="btn-md-code" class="px-2 text-xs text-gray-500">Code</button></div><button onclick="deleteCurrentFile()" class="text-red-600 hover:bg-red-50 px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-1"><i data-lucide="trash-2" class="w-4 h-4"></i> Delete</button><button onclick="downloadCurrentFile()"><i data-lucide="download" class="w-4 h-4"></i></button><button onclick="editCurrentFile()"><i data-lucide="pencil" class="w-4 h-4"></i></button><button onclick="openRawView()"><i data-lucide="code" class="w-4 h-4"></i></button></div></div><div class="flex-1 p-6 overflow-hidden bg-[#282c34] relative"><div id="readonly-editor" class="w-full h-full"></div><div id="markdown-preview" class="hidden absolute inset-6 bg-white overflow-y-auto p-8 markdown-body"></div></div></div>
        </main>
    </div>

    <div id="modal-create-project" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50"><div class="bg-white rounded-xl p-6 w-full max-w-md"><h3 class="font-bold mb-4">New Project</h3><input id="new-project-name" class="w-full border px-4 py-2 rounded-lg mb-4" placeholder="Name"><div class="flex justify-end gap-2"><button onclick="closeCreateModal()">Cancel</button><button onclick="handleCreateProject(event)" class="bg-green-600 text-white px-4 py-2 rounded-lg">Create</button></div></div></div>
    <div id="modal-upload-file" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50"><div class="bg-white rounded-xl p-6 w-full max-w-md"><h3 class="font-bold mb-4">Upload</h3><div onclick="document.getElementById('file-input').click()" class="border-2 border-dashed p-8 text-center cursor-pointer"><input type="file" id="file-input" class="hidden" onchange="handleFileSelect(event)"><p>Select File</p></div><div id="upload-preview" class="hidden mt-4 p-2 bg-blue-50 text-sm"><span id="upload-filename"></span></div><button onclick="confirmUpload()" id="btn-confirm-upload" disabled class="w-full mt-4 bg-gray-300 text-white px-4 py-2 rounded-lg">Upload</button><button onclick="closeUploadModal()" class="w-full mt-2 text-gray-500">Cancel</button></div></div>

    <script>
        const ALLOWED_EMAILS = ["bluerblx160@gmail.com", "zian.mabry@portsk12.com"];
        let currentUser = null, projects = [], apiKeys = [], userSettings = {}, activeProjectId = null, activeFileIndex = -1, editingFileIndex = -1, pendingAuthEmail = "", pendingUploadContent = null, aceEditor, readOnlyEditor;
        let isEditing = false;

        window.onload = async () => {
            initEditors(); lucide.createIcons();
            const savedUser = localStorage.getItem('aethel_session_user');
            pendingAuthEmail = sessionStorage.getItem('pendingAuthEmail') || "";
            if(pendingAuthEmail && !savedUser) { document.getElementById('login-container').classList.add('hidden'); document.getElementById('apikey-container').classList.remove('hidden'); }
            if(savedUser) { 
                const u = JSON.parse(savedUser);
                await fetchUserData(u.email);
                currentUser = u;
                if(u.authType === 'admin') await fetchAdminData();
                completeLogin(u.role);
                setInterval(pollData, 3000); 
            }
        };

        async function pollData() {
            if(!currentUser) return;
            try {
                const res = await fetch(`/api/user/data?email=${currentUser.email}`);
                const data = await res.json();
                if(!isEditing) {
                    projects = data.projects || [];
                    userSettings = { [currentUser.email]: data.settings || {} };
                    if(document.getElementById('view-projects').classList.contains('hidden') === false) renderProjects();
                    if(document.getElementById('view-project-detail').classList.contains('hidden') === false) {
                        const p = projects.find(x=>x.id===activeProjectId);
                        if(p) { renderFiles(); renderCollaborators(); checkReadme(p); }
                    }
                }
            } catch(e) {}
        }

        function initEditors() { 
            aceEditor=ace.edit("editor-container"); aceEditor.setTheme("ace/theme/one_dark"); aceEditor.session.setMode("ace/mode/javascript"); 
            readOnlyEditor=ace.edit("readonly-editor"); readOnlyEditor.setTheme("ace/theme/one_dark"); readOnlyEditor.session.setMode("ace/mode/javascript"); readOnlyEditor.setReadOnly(true); 
        }

        async function fetchUserData(email) { const res=await fetch(`/api/user/data?email=${email}`); const data=await res.json(); projects=data.projects||[]; userSettings={[email]:data.settings||{}}; }
        async function syncUserData() { if(!currentUser)return; await fetch('/api/user/data', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email: currentUser.email, projects: projects, settings: userSettings[currentUser.email] }) }); }
        async function fetchAdminData() { const kRes=await fetch('/api/admin/keys'); apiKeys=await kRes.json(); const rRes=await fetch('/api/admin/registrations'); renderRegistrationList(await rRes.json()); }

        async function handleEmailSubmit(e) { e.preventDefault(); const email=document.getElementById('email').value.trim().toLowerCase(); if(ALLOWED_EMAILS.includes(email)){currentUser={email,role:"Admin Access",authType:'admin'};await fetchUserData(email);await fetchAdminData();attemptLogin(email,"Admin Access",'admin');}else{pendingAuthEmail=email;sessionStorage.setItem('pendingAuthEmail',email);document.getElementById('login-container').classList.add('hidden');document.getElementById('apikey-container').classList.remove('hidden');} }
        async function handleApiKeySubmit(e) { e.preventDefault(); const key=document.getElementById('apikey').value.trim(); if(!pendingAuthEmail)return alert("Error"); const res=await fetch('/api/auth/key-login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({key,email:pendingAuthEmail})}); const data=await res.json(); if(data.success){currentUser={email:pendingAuthEmail,role:data.role,authType:'key'};await fetchUserData(currentUser.email);attemptLogin(currentUser.email,data.role,'key');}else{document.getElementById('api-error').innerText=data.error;document.getElementById('api-error').classList.remove('hidden');} }
        function attemptLogin(email,r,t) { const s=userSettings[email]||{}; if(s.twoFactor){trigger2FAFlow(email);}else{finalizeLogin();} }
        function finalizeLogin() { localStorage.setItem('aethel_session_user', JSON.stringify(currentUser)); sessionStorage.removeItem('pendingAuthEmail'); completeLogin(currentUser.role); setInterval(pollData, 3000); }
        function completeLogin(role) { document.getElementById('auth-wrapper').classList.add('hidden'); document.getElementById('dashboard-container').classList.remove('hidden'); const s=userSettings[currentUser.email]||{}; if(s.isAnonymous){document.getElementById('display-name').innerText="Anonymous";document.getElementById('user-avatar').innerText="?";}else{document.getElementById('display-name').innerText=s.username||currentUser.email;document.getElementById('user-avatar').innerText=currentUser.email[0].toUpperCase();} document.getElementById('access-level').innerText=role; 
            
            // Auto-Enable Security Defaults for New Users
            if (s.twoFactor === undefined) { s.twoFactor = true; userSettings[currentUser.email].twoFactor = true; syncUserData(); }
            if (!s.pin) { s.pin = "0000"; userSettings[currentUser.email].pin = "0000"; syncUserData(); alert("Security Alert: Your default PIN is 0000. Please change it in Settings."); }

            document.getElementById('setting-pin').value=s.pin; document.getElementById('setting-2fa-toggle').checked=s.twoFactor; document.getElementById('setting-username').value=s.username||''; document.getElementById('setting-anon-toggle').checked=s.isAnonymous||false; if(role==='Admin Access')document.getElementById('admin-tabs').classList.remove('hidden'); renderProjects(); }
        function logout() { localStorage.removeItem('aethel_session_user'); location.reload(); } function backToEmail(){document.getElementById('apikey-container').classList.add('hidden');document.getElementById('login-container').classList.remove('hidden');}
        
        function trigger2FAFlow(e){document.getElementById('login-container').classList.add('hidden');document.getElementById('apikey-container').classList.add('hidden');document.getElementById('2fa-email-modal').classList.remove('hidden');document.getElementById('2fa-target-email').innerText=e;}
        function openPinEntry() { document.getElementById('2fa-email-modal').classList.add('hidden'); document.getElementById('2fa-pin-modal').classList.remove('hidden'); }
        function verifyPinAndLogin() { if(document.getElementById('pin-input').value===userSettings[currentUser.email].pin){document.getElementById('2fa-pin-modal').classList.add('hidden');finalizeLogin();}else{document.getElementById('pin-error').classList.remove('hidden');} }

        async function generateApiKey(){const res=await fetch('/api/admin/generate-key',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({duration:document.getElementById('api-duration').value})});const data=await res.json();apiKeys=data.keys;document.getElementById('new-key-text').innerText=data.key;document.getElementById('generated-key-display').classList.remove('hidden');renderApiKeys();}
        async function expireKey(k) { if(confirm('Revoke key?')) { await fetch('/api/admin/expire-key', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ key: k }) }); fetchAdminData(); } }
        async function extendKey(k) { const d = prompt('Enter new duration (days):'); if(d) { await fetch('/api/admin/extend-key', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ key: k, duration: d }) }); fetchAdminData(); } }
        function renderApiKeys(){const t=document.getElementById('api-keys-list');t.innerHTML='';apiKeys.forEach(k=>{const isExpired=new Date()>new Date(k.expiresAt);const status=isExpired?`<span class="text-red-500">Expired</span>`:`<span class="text-green-500">Active</span>`; t.innerHTML+=`<tr class="hover:bg-gray-50"><td class="px-6 py-4 font-mono text-xs">${k.key.substring(0,10)}...</td><td class="px-6 py-4">${k.usedBy}</td><td class="px-6 py-4">${new Date(k.expiresAt).toLocaleDateString()}</td><td class="px-6 py-4 flex gap-2 items-center">${status} <button onclick="expireKey('${k.key}')" class="text-red-600 text-xs border border-red-200 px-2 py-1 rounded hover:bg-red-50">Revoke</button> <button onclick="extendKey('${k.key}')" class="text-blue-600 text-xs border border-blue-200 px-2 py-1 rounded hover:bg-blue-50">Extend</button></td></tr>`;});}
        function renderRegistrationList(regs){const t=document.getElementById('registration-list');t.innerHTML='';regs.forEach(r=>{t.innerHTML+=`<tr class="hover:bg-gray-50"><td class="px-6 py-4">${r.email}</td><td class="px-6 py-4 font-mono text-xs">${r.key}</td><td class="px-6 py-4">${new Date(r.usedDate).toLocaleDateString()}</td></tr>`;});}

        function saveProfile(){userSettings[currentUser.email]=userSettings[currentUser.email]||{};userSettings[currentUser.email].username=document.getElementById('setting-username').value;syncUserData().then(()=>{completeLogin(currentUser.role);alert('Updated');});}
        function toggleAnonymous(){userSettings[currentUser.email]=userSettings[currentUser.email]||{};userSettings[currentUser.email].isAnonymous=document.getElementById('setting-anon-toggle').checked;syncUserData().then(()=>completeLogin(currentUser.role));}
        function savePin(){userSettings[currentUser.email]=userSettings[currentUser.email]||{};userSettings[currentUser.email].pin=document.getElementById('setting-pin').value;syncUserData().then(()=>alert('Saved'));}
        function toggle2FA(){userSettings[currentUser.email]=userSettings[currentUser.email]||{};userSettings[currentUser.email].twoFactor=document.getElementById('setting-2fa-toggle').checked;syncUserData();}

        function switchTab(t){['view-projects','view-admin-api','view-admin-registration','view-settings','view-project-detail','view-editor','view-file-display'].forEach(id=>document.getElementById(id).classList.add('hidden')); 
            const activeClass = ['bg-blue-50/50', 'text-blue-700', 'border-blue-100'];
            ['projects', 'api', 'registration', 'settings'].forEach(k => {
                const btn = document.getElementById(`tab-btn-${k}`);
                if(btn) btn.classList.remove(...activeClass);
            });
            if(t==='projects'){document.getElementById('view-projects').classList.remove('hidden'); document.getElementById('tab-btn-projects').classList.add(...activeClass);}
            if(t==='api'){document.getElementById('view-admin-api').classList.remove('hidden');renderApiKeys(); document.getElementById('tab-btn-api').classList.add(...activeClass);}
            if(t==='registration'){document.getElementById('view-admin-registration').classList.remove('hidden'); document.getElementById('tab-btn-registration').classList.add(...activeClass);}
            if(t==='global-settings'){document.getElementById('view-settings').classList.remove('hidden'); document.getElementById('tab-btn-settings').classList.add(...activeClass);}
        }
        function openCreateModal(){document.getElementById('modal-create-project').classList.remove('hidden');} function closeCreateModal(){document.getElementById('modal-create-project').classList.add('hidden');}
        function handleCreateProject(e){e.preventDefault();projects.push({id:Date.now(),owner:currentUser.email,name:document.getElementById('new-project-name').value,lastUpdated:new Date().toLocaleDateString(),files:[{name:'README.md',content:`# ${document.getElementById('new-project-name').value}\n\nWelcome.\n\`\`\`lua\nprint("Hello")\n\`\`\``,date:'Just now'}],collaborators:[]});syncUserData();closeCreateModal();renderProjects();}
        function renderProjects(){const g=document.getElementById('projects-grid');g.innerHTML='';if(projects.length===0){document.getElementById('empty-state').classList.remove('hidden');document.getElementById('empty-state').classList.add('flex');}else{document.getElementById('empty-state').classList.add('hidden');document.getElementById('empty-state').classList.remove('flex');projects.forEach(p=>{const isShared=p.owner&&p.owner!==currentUser.email;const tag=isShared?'<span class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full">Shared</span>':'';g.innerHTML+=`<div onclick="openProjectDetail(${p.id})" class="bg-white p-6 rounded-2xl shadow-sm border cursor-pointer hover:shadow-lg transition"><div class="flex justify-between"><h3 class="font-bold text-gray-800">${p.name}</h3>${tag}</div><p class="text-sm text-gray-500">${p.files.length} files</p></div>`;});}}
        
        function openProjectDetail(id){activeProjectId=id;const p=projects.find(x=>x.id===id);document.getElementById('detail-project-name').innerText=p.name;document.getElementById('detail-owner-tag').innerText=p.owner&&p.owner!==currentUser.email?`Owner: ${p.owner}`:'';renderFiles();switchTab('none');document.getElementById('view-project-detail').classList.remove('hidden');switchProjectTab('code'); renderCollaborators(); checkReadme(p);}
        function checkReadme(p){const rm=p.files.find(f=>f.name.toLowerCase()==='readme.md');const rc=document.getElementById('readme-section');const content=document.getElementById('readme-content');if(rm){rc.classList.remove('hidden');content.innerHTML=marked.parse(rm.content);hljs.highlightAll();document.querySelectorAll('#readme-content pre code').forEach(el=>{const btn=document.createElement('button');btn.className='copy-btn';btn.innerText='Copy';btn.onclick=()=>copyText(btn,el.innerText);el.parentElement.appendChild(btn);});}else{rc.classList.add('hidden');}}
        function closeProjectView(){switchTab('projects');}
        
        function switchProjectTab(t){
            document.getElementById('project-code-panel').classList.add('hidden');document.getElementById('project-settings-panel').classList.add('hidden'); 
            document.getElementById('ptab-code').classList.remove('border-orange-500'); document.getElementById('ptab-code').classList.add('border-transparent');
            document.getElementById('ptab-settings').classList.remove('border-orange-500'); document.getElementById('ptab-settings').classList.add('border-transparent');
            
            if(t==='code'){
                document.getElementById('project-code-panel').classList.remove('hidden');
                document.getElementById('ptab-code').classList.remove('border-transparent');
                document.getElementById('ptab-code').classList.add('border-orange-500');
            }
            if(t==='settings'){
                document.getElementById('project-settings-panel').classList.remove('hidden');
                document.getElementById('ptab-settings').classList.remove('border-transparent');
                document.getElementById('ptab-settings').classList.add('border-orange-500');
                document.getElementById('setting-project-name').value=projects.find(x=>x.id===activeProjectId).name;renderCollaborators();
            }
        }
        
        function saveProjectName(){const p=projects.find(x=>x.id===activeProjectId);if(p.owner&&p.owner!==currentUser.email)return alert("Only the owner can rename."); p.name=document.getElementById('setting-project-name').value;syncUserData();document.getElementById('detail-project-name').innerText=p.name;alert('Saved');}
        function deleteProject(){const p=projects.find(x=>x.id===activeProjectId);if(p.owner&&p.owner!==currentUser.email)return alert("Only the owner can delete."); if(confirm("Delete?")){projects=projects.filter(x=>x.id!==activeProjectId);syncUserData();switchTab('projects');}}

        async function searchUsers(){ const q=document.getElementById('collab-search').value.trim(); if(q.length<2)return; const res=await fetch(`/api/user/search?q=${q}`); const users=await res.json(); const div=document.getElementById('search-results'); div.innerHTML=''; div.classList.remove('hidden'); if(users.length===0) div.innerHTML='<div class="text-sm text-gray-500 p-2">No users found</div>'; users.forEach(u=>{ if(u.email===currentUser.email)return; div.innerHTML+=`<div onclick="addCollaborator('${u.email}')" class="p-2 hover:bg-gray-100 cursor-pointer text-sm"><b>${u.username}</b> (${u.email})</div>`;}); }
        function addCollaborator(email){ const p=projects.find(x=>x.id===activeProjectId); if(p.owner&&p.owner!==currentUser.email)return alert("Only owner can add people."); if(!p.collaborators)p.collaborators=[]; if(!p.collaborators.includes(email)){ p.collaborators.push(email); syncUserData(); renderCollaborators(); document.getElementById('search-results').classList.add('hidden'); document.getElementById('collab-search').value=''; alert(`Added ${email}`); } }
        function removeCollaborator(email){ const p=projects.find(x=>x.id===activeProjectId); if(p.owner&&p.owner!==currentUser.email)return alert("Only owner can remove people."); p.collaborators = p.collaborators.filter(c => c !== email); syncUserData(); renderCollaborators(); }
        function renderCollaborators(){ const p=projects.find(x=>x.id===activeProjectId); const l=document.getElementById('collab-list'); l.innerHTML=''; if(p.collaborators && p.collaborators.length > 0) { p.collaborators.forEach(c => { l.innerHTML += `<div class="flex justify-between items-center text-sm p-2 bg-gray-50 rounded"><span>${c}</span><div class="flex gap-2 items-center"><span class="text-xs bg-green-100 text-green-600 px-2 rounded">Can Edit</span><button onclick="removeCollaborator('${c}')" class="text-red-500 hover:text-red-700 font-bold px-2">X</button></div></div>`; }); } else { l.innerHTML = '<p class="text-sm text-gray-400">No collaborators yet.</p>'; } }

        function renderFiles(){
            const list=document.getElementById('file-list-container');list.innerHTML='';
            const p = projects.find(x=>x.id===activeProjectId);
            // Folder logic grouping
            p.files.sort((a,b)=>a.name.localeCompare(b.name)).forEach((f,i)=>{
                let display = f.name;
                if(f.name.includes('/')) {
                    const parts = f.name.split('/');
                    const path = parts.slice(0, parts.length-1).join('/');
                    const name = parts[parts.length-1];
                    display = `<span class="text-gray-400 text-xs mr-1">${path}/</span><span class="font-bold text-gray-700">${name}</span>`;
                } else {
                    display = `<span class="font-bold text-gray-700">${f.name}</span>`;
                }
                list.innerHTML+=`<div onclick="openFileViewer(${i})" class="flex justify-between p-4 cursor-pointer hover:bg-gray-50"><div class="flex gap-2"><i data-lucide="file-code" class="w-4 h-4 text-gray-500"></i><span class="font-mono text-sm">${display}</span></div><span class="text-xs text-gray-400">${f.date||''}</span></div>`;
            });
            lucide.createIcons();
        }
        function openFileViewer(i){activeFileIndex=i;const f=projects.find(x=>x.id===activeProjectId).files[i];document.getElementById('display-filename').innerText=f.name;readOnlyEditor.setValue(f.content);readOnlyEditor.clearSelection();if(f.name.endsWith('.md')){document.getElementById('md-toggle-container').classList.remove('hidden');document.getElementById('markdown-preview').innerHTML=marked.parse(f.content);hljs.highlightAll();document.querySelectorAll('#markdown-preview pre code').forEach(el=>{const btn=document.createElement('button');btn.className='copy-btn';btn.innerText='Copy';btn.onclick=()=>copyText(btn,el.innerText);el.parentElement.appendChild(btn)});toggleMdView('preview');}else{document.getElementById('md-toggle-container').classList.add('hidden');toggleMdView('code');}document.getElementById('view-project-detail').classList.add('hidden');document.getElementById('view-file-display').classList.remove('hidden');}
        function toggleMdView(m){const e=document.getElementById('readonly-editor'),p=document.getElementById('markdown-preview');if(m==='preview'){e.style.display='none';p.classList.remove('hidden');}else{e.style.display='block';p.classList.add('hidden');}}
        function copyText(b,t) { const ta=document.createElement('textarea');ta.value=t;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);b.innerText="Copied!";setTimeout(()=>b.innerText="Copy",2000); }
        function openAddFileView(){editingFileIndex=-1;document.getElementById('view-project-detail').classList.add('hidden');document.getElementById('view-editor').classList.remove('hidden');document.getElementById('editor-filename').value='';aceEditor.setValue('');isEditing=true;}
        function cancelEdit(){document.getElementById('view-editor').classList.add('hidden');document.getElementById('view-project-detail').classList.remove('hidden');isEditing=false;}
        function commitFile(){const n=document.getElementById('editor-filename').value,c=aceEditor.getValue(),p=projects.find(x=>x.id===activeProjectId);if(editingFileIndex>-1){p.files[editingFileIndex].content=c;}else{p.files.push({name:n,content:c,date:'Just now',type:'Code'});}syncUserData();renderFiles();cancelEdit();checkReadme(p);}
        function editCurrentFile(){editingFileIndex=activeFileIndex;const f=projects.find(x=>x.id===activeProjectId).files[activeFileIndex];document.getElementById('view-file-display').classList.add('hidden');document.getElementById('view-editor').classList.remove('hidden');document.getElementById('editor-filename').value=f.name;aceEditor.setValue(f.content);isEditing=true;}
        function downloadCurrentFile(){const f=projects.find(x=>x.id===activeProjectId).files[activeFileIndex],a=document.createElement('a');a.href=URL.createObjectURL(new Blob([f.content]));a.download=f.name;a.click();}
        function deleteCurrentFile(){if(confirm("Delete file?")){const p=projects.find(x=>x.id===activeProjectId);p.files.splice(activeFileIndex,1);syncUserData();renderFiles();checkReadme(p);document.getElementById('view-file-display').classList.add('hidden');document.getElementById('view-project-detail').classList.remove('hidden');}}
        function openRawView(){
            const p=projects.find(x=>x.id===activeProjectId);
            const f=p.files[activeFileIndex];
            const url = `/raw/${encodeURIComponent(p.name)}/${encodeURIComponent(f.name)}`;
            window.open(url, '_blank');
        }
        
        function openUploadModal(){document.getElementById('modal-upload-file').classList.remove('hidden');} function closeUploadModal(){document.getElementById('modal-upload-file').classList.add('hidden');}
        function handleFileSelect(e){const f=e.target.files[0]; const r=new FileReader(); r.onload=v=>{pendingUploadContent=v.target.result;document.getElementById('btn-confirm-upload').disabled=false;document.getElementById('upload-preview').classList.remove('hidden');document.getElementById('upload-filename').innerText=f.name;document.getElementById('btn-confirm-upload').classList.replace('bg-gray-300','bg-blue-600');}; r.readAsText(f);}
        function confirmUpload(){closeUploadModal(); editingFileIndex=-1; document.getElementById('view-project-detail').classList.add('hidden'); document.getElementById('view-editor').classList.remove('hidden'); document.getElementById('editor-filename').value=document.getElementById('upload-filename').innerText; aceEditor.setValue(pendingUploadContent); isEditing=true;}
    </script>
</body>
</html>
